<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#63b3ab" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Voice Input - Todo List</title>
    <!-- Manifest disabled: Cloudflare Access blocks it causing CORS errors -->
    <!-- <link rel="manifest" href="/voice/manifest.json" /> -->
    <link rel="icon" href="/voice/favicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="/voice/apple-touch-icon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      /* Design tokens matching globals.css */
      :root {
        --bg-base: #0c0c0f;
        --bg-primary: #121218;
        --surface-1: #16161d;
        --surface-2: #1e1e28;
        --text-primary: #f4f4f6;
        --text-secondary: #9ca3af;
        --text-tertiary: #6b7280;
        --accent: #63b3ab;
        --accent-hover: #7cc4bd;
        --accent-muted: rgba(99, 179, 171, 0.15);
        --success: #34d399;
        --success-muted: rgba(52, 211, 153, 0.15);
        --danger: #f87171;
        --danger-muted: rgba(248, 113, 113, 0.15);
        --border: rgba(255, 255, 255, 0.06);
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        --radius-full: 9999px;
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
        --glow-accent: 0 0 20px rgba(99, 179, 171, 0.3);
        --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-base: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-base);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-primary);
        padding: 1rem;
      }

      .container {
        text-align: center;
        max-width: 400px;
        width: 100%;
      }

      .card {
        background: var(--surface-1);
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: 2rem;
        margin-bottom: 1rem;
      }

      h1 {
        font-size: 1.875rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        letter-spacing: -0.025em;
        background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .subtitle {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 2rem;
        line-height: 1.5;
      }

      .status {
        font-size: 1rem;
        margin-bottom: 1.5rem;
        color: var(--text-secondary);
        min-height: 1.5rem;
      }

      .mic-button {
        width: 120px;
        height: 120px;
        border-radius: var(--radius-full);
        border: 2px solid var(--border);
        background: var(--surface-2);
        cursor: pointer;
        transition: all var(--transition-base);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        position: relative;
      }

      .mic-button:hover {
        border-color: var(--accent);
        background: var(--accent-muted);
        transform: scale(1.02);
      }

      .mic-button.listening {
        border-color: var(--accent);
        background: var(--accent-muted);
        animation: pulse 1.5s ease-in-out infinite;
      }

      .mic-button.processing {
        border-color: var(--text-tertiary);
        background: var(--surface-2);
        cursor: not-allowed;
        opacity: 0.7;
      }

      @keyframes pulse {
        0%, 100% {
          box-shadow: 0 0 0 0 rgba(99, 179, 171, 0.4);
        }
        50% {
          box-shadow: 0 0 0 20px rgba(99, 179, 171, 0);
        }
      }

      .mic-icon {
        width: 48px;
        height: 48px;
        color: var(--text-secondary);
        transition: color var(--transition-fast);
      }

      .mic-button:hover .mic-icon,
      .mic-button.listening .mic-icon {
        color: var(--accent);
      }

      .transcript {
        background: var(--surface-2);
        border: 1px solid var(--border);
        padding: 1rem;
        border-radius: var(--radius-lg);
        font-size: 1rem;
        line-height: 1.6;
        margin-bottom: 1rem;
        color: var(--text-primary);
        text-align: left;
      }

      .message {
        padding: 0.75rem 1rem;
        border-radius: var(--radius-lg);
        font-size: 0.875rem;
        margin-top: 1rem;
      }

      .error {
        color: var(--danger);
        background: var(--danger-muted);
        border: 1px solid var(--danger);
      }

      .success {
        color: var(--success);
        background: var(--success-muted);
        border: 1px solid var(--success);
      }

      .hidden {
        display: none;
      }

      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
        transition: color var(--transition-fast);
        margin-top: 1rem;
      }

      .back-link:hover {
        color: var(--accent);
      }

      .back-link svg {
        width: 16px;
        height: 16px;
      }

      .browser-warning {
        background: var(--danger-muted);
        border: 1px solid var(--danger);
        border-radius: var(--radius-lg);
        padding: 1rem;
        margin-bottom: 1rem;
        text-align: left;
      }

      .browser-warning h3 {
        color: var(--danger);
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .browser-warning p {
        color: var(--text-secondary);
        font-size: 0.813rem;
        line-height: 1.5;
        margin: 0;
      }

      .browser-warning a {
        color: var(--accent);
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="browser-warning hidden" id="braveWarning">
        <h3>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
            <path d="M12 9v4"/><path d="M12 17h.01"/>
          </svg>
          Voice Input Not Supported in Brave Desktop
        </h3>
        <p>
          Brave browser on desktop blocks the Web Speech API for privacy reasons.
          Please use <strong>Chrome</strong>, <strong>Edge</strong>, or <strong>Safari</strong> instead,
          or use Brave on your Android phone where it works via on-device recognition.
          <a href="https://github.com/brave/brave-browser/issues/3725" target="_blank" rel="noopener">Learn more</a>
        </p>
      </div>

      <div class="card">
        <h1>Voice Input</h1>
        <p class="subtitle">Tap the microphone and speak to add items to your lists</p>

        <div class="status" id="status">Tap microphone to start</div>

        <button class="mic-button" id="micButton" aria-label="Record voice input">
          <svg class="mic-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" />
            <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
            <line x1="12" y1="19" x2="12" y2="22" />
          </svg>
        </button>

        <div class="transcript hidden" id="transcript"></div>
        <div class="message error hidden" id="error"></div>
        <div class="message success hidden" id="success"></div>
      </div>

      <a href="/lists" class="back-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        Back to Lists
      </a>
    </div>

    <script>
      // Configuration
      const API_BASE_URL = window.location.origin;
      let recognition = null;
      let isListening = false;
      let isProcessing = false;

      // Detect desktop Brave browser and show warning
      // Brave on desktop blocks Web Speech API; Brave on Android works via on-device recognition
      function isDesktopBrave() {
        const ua = navigator.userAgent;
        const isBrave = navigator.brave && navigator.brave.isBrave || /Brave/.test(ua);
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
        return isBrave && !isMobile;
      }

      if (isDesktopBrave()) {
        document.getElementById('braveWarning').classList.remove('hidden');
      }

      // DOM elements
      const micButton = document.getElementById('micButton');
      const statusEl = document.getElementById('status');
      const transcriptEl = document.getElementById('transcript');
      const errorEl = document.getElementById('error');
      const successEl = document.getElementById('success');

      // Check for Web Speech API support
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showError('Web Speech API is not supported in this browser. Please use Chrome or Edge.');
        micButton.disabled = true;
      } else {
        // Initialize speech recognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = () => {
          console.log('Speech recognition started');
          isListening = true;
          micButton.classList.add('listening');
          statusEl.textContent = 'Listening...';
          hideMessages();
        };

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          const confidence = event.results[0][0].confidence;
          console.log('Speech recognition result:', { transcript, confidence });
          transcriptEl.textContent = transcript;
          transcriptEl.classList.remove('hidden');
          statusEl.textContent = 'Processing...';
          sendToAPI(transcript);
        };

        recognition.onerror = (event) => {
          console.error('Speech recognition error:', {
            error: event.error,
            message: event.message,
            timestamp: new Date().toISOString()
          });

          let errorMessage = `Speech recognition error: ${event.error}`;

          // Provide helpful messages for common errors
          if (event.error === 'network') {
            errorMessage = 'Network error: Unable to connect to speech service. Please check your internet connection.';
          } else if (event.error === 'not-allowed') {
            errorMessage = 'Microphone access denied. Please grant microphone permissions and try again.';
          } else if (event.error === 'service-not-allowed') {
            errorMessage = 'Speech service not allowed. This may be due to security settings or network restrictions.';
          } else if (event.error === 'aborted') {
            errorMessage = 'Speech recognition aborted. Please try again.';
          }

          if (event.error !== 'no-speech') {
            showError(errorMessage);
          }
          resetUI();
        };

        recognition.onend = () => {
          if (isListening && !isProcessing) {
            resetUI();
          }
        };
      }

      // Auto-start if URL parameter is present
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('autostart') === '1' && recognition) {
        setTimeout(() => {
          startListening();
        }, 500);
      }

      // Microphone button click handler
      micButton.addEventListener('click', () => {
        if (isListening || isProcessing) {
          stopListening();
        } else {
          startListening();
        }
      });

      function startListening() {
        if (!recognition) return;

        try {
          console.log('Attempting to start speech recognition...');
          recognition.start();
        } catch (error) {
          console.error('Failed to start recognition:', error);
          showError('Failed to start voice recognition. Please try again.');
        }
      }

      function stopListening() {
        if (recognition && isListening) {
          recognition.stop();
        }
        resetUI();
      }

      function resetUI() {
        isListening = false;
        isProcessing = false;
        micButton.classList.remove('listening', 'processing');
        statusEl.textContent = 'Tap microphone to start';
      }

      function hideMessages() {
        errorEl.classList.add('hidden');
        successEl.classList.add('hidden');
      }

      function showError(message) {
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
        successEl.classList.add('hidden');
      }

      function showSuccess(message) {
        successEl.textContent = message;
        successEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
      }

      async function sendToAPI(text) {
        isProcessing = true;
        micButton.classList.remove('listening');
        micButton.classList.add('processing');

        try {
          // Get auth token from localStorage
          const token = localStorage.getItem('token');
          if (!token) {
            throw new Error('Not authenticated. Please log in first.');
          }

          console.log('Sending to API:', { text, url: `${API_BASE_URL}/api/v1/voice` });

          // Send to voice API
          const response = await fetch(`${API_BASE_URL}/api/v1/voice`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ raw_text: text }),
          });

          console.log('API response status:', response.status);

          if (!response.ok) {
            const error = await response.json();
            console.error('API error response:', error);
            throw new Error(error.detail || 'Failed to process voice input');
          }

          const data = await response.json();
          console.log('API success response:', data);
          statusEl.textContent = 'Processing complete!';
          showSuccess('Redirecting to confirmation page...');

          // Redirect to confirmation page after 1.5 seconds
          setTimeout(() => {
            window.location.href = '/confirm';
          }, 1500);
        } catch (error) {
          console.error('API error:', error);
          showError(error.message);
          statusEl.textContent = 'Error processing voice input';
        } finally {
          isProcessing = false;
          micButton.classList.remove('processing');
        }
      }
    </script>
  </body>
</html>
